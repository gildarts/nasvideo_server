{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/common/database.ts","webpack:///./src/common/fs_util.ts","webpack:///./src/common/middlewares.ts","webpack:///./src/common/session_store.ts","webpack:///./src/config.ts","webpack:///./src/ffmpeg/cli.ts","webpack:///./src/ffmpeg/ffmpeg.ts","webpack:///./src/ffmpeg/index.ts","webpack:///./src/ffmpeg/time_util.ts","webpack:///./src/server.ts","webpack:///./src/service/acl.ts","webpack:///./src/service/fs.ts","webpack:///./src/service/index.ts","webpack:///./src/service/video.ts","webpack:///./src/videofs/fs_entry.ts","webpack:///./src/videofs/util.ts","webpack:///./src/videofs/video_file.ts","webpack:///./src/videofs/video_fs.ts","webpack:///external \"child_process\"","webpack:///external \"./config.json\"","webpack:///external \"fs-extra\"","webpack:///external \"http\"","webpack:///external \"koa\"","webpack:///external \"koa-bodyparser\"","webpack:///external \"koa-router\"","webpack:///external \"koa-send\"","webpack:///external \"koa-session\"","webpack:///external \"koa-static\"","webpack:///external \"moment\"","webpack:///external \"path\"","webpack:///external \"pg-promise\"","webpack:///external \"query-string\"","webpack:///external \"send\"","webpack:///external \"tslib\""],"names":[],"mappings":"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","file":"server.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/server.ts\");\n","/**\n * 資料庫相關初始設定。\n *\n * Library：https://github.com/vitaly-t/pg-promise\n * Example : https://github.com/vitaly-t/pg-promise/wiki/Learn-by-Example#single-parameter\n * TypeScript Ext Document：https://github.com/vitaly-t/pg-promise/tree/master/typescript\n */\n\nimport PGP from 'pg-promise';\nimport conf from '../config';\nimport PG from 'pg-promise';\n\nconst pgp = PG();\n\n/**資料庫操作介面 */\nexport interface PGConnection extends PGP.IDatabase<any> {\n}\n\n/** 資料庫連線 instance。 */\nexport const db = {\n    /** 預設資料庫連線(字音字形網資料庫)。 */\n    default: pgp<PGConnection>(conf.db)\n}\n\n","import path from 'path';\n\nexport class FSUtil {\n\n    /** 將檔案路徑切割為「檔案」與「路徑」。 */\n    public static pathSplite(filePath: string) {\n        const paths = filePath.split('/').reverse();\n\n        const file = paths.shift()\n        const ext = path.extname(file);\n        const base = path.basename(file, ext);\n        return {\n            /** 檔案名稱。 */\n            file,\n            /** 副檔名。 */\n            ext,\n            /** 主檔名。 */\n            base,\n            /** 路徑 */\n            path: paths.reverse().join('/')\n        }\n    }\n}","import { ServiceContext } from '../types';\nimport { db } from './database';\nimport { getVideoRoot } from '../config';\n\nexport const setXFrameOptionsDENY = (ctx: ServiceContext, next: () => Promise<void>) => {\n    ctx.response.set({\n        'X-Frame-Options': 'DENY',\n    })\n    return next();\n}\n\nexport const setupDBConnection = (ctx: ServiceContext, next: () => Promise<void>) => {\n    ctx.db = db.default;\n    return next();\n}\n\n\nexport const checkSessionData = (ctx: ServiceContext, next: () => Promise<void>) => {\n    if(ctx.session_error) {\n        const { message } = ctx.session_error;\n        ctx.status = 500;\n        ctx.body = { message };\n    } else {\n        return next();\n    }\n}\n\nexport const setVideoRoot = (ctx: ServiceContext, next: () => Promise<void>) => {   \n    ctx.videoRoot = getVideoRoot(ctx.session.video_src);\n    return next();\n};\n","import { db } from './database';\nimport moment from 'moment';\nimport KoaSession from 'koa-session';\nimport Koa from 'koa';\n\nconst connection = db.default;\nconst TableName = 'session';\n\nconst db_store = {\n    get: async (key: string, maxAge: number, { rolling }: { rolling: any }) => {\n        try {\n            const cmd = `select * from ${TableName} where session_id = $(key)`;\n            const record = await connection.oneOrNone(cmd, { key: key });\n    \n            if (record) {\n                const data = record.data || {};\n                data._id = key;\n                return data;\n            } else {\n                return null;\n            }\n        } catch(err) {\n            return { __session_error: err };\n        }\n    },\n    set: async (key: string, sess: any, maxAge: number, { rolling, changed }: { rolling: any, changed: any }) => {\n\n        try {\n            if (!changed) return;\n\n            const data = JSON.stringify(sess);\n            const time = moment().add(1, \"hour\").valueOf();\n\n            const get = `select expiry_date from ${TableName} where session_id = $(key)`;\n            const record = await connection.oneOrNone(get, { key: key });\n            if (record) {\n                const cmd = `update ${TableName} set expiry_date = $(time), data = $(data) where session_id = $(key)`;\n                await connection.none(cmd, { key: key, time: time, data: data });\n            } else {\n                const cmd = `insert into ${TableName}(session_id, expiry_date, data) values($(key), $(time), $(data))`;\n                await connection.none(cmd, { key: key, time: time, data: data });\n            }\n        } catch (error) {\n            console.error(`set session occure error: ${error.message}`);\n        }\n    },\n    destroy: async (key: string) => {\n        const cmd = `delete from ${TableName} where session_id = $(key)`;\n        await connection.none(cmd, { key: key });\n    }\n};\n\nconst session_conf = {\n    key: 'hlc_boe_web', /** (string) cookie key (default is koa:sess) */\n    maxAge: 24 * 60 * 60 * 1000 * 1000, // 用戶端 cookie 過期時間，多久沒使用 cookie 會失效。\n    overwrite: true, /** (boolean) can overwrite or not (default true) */\n    httpOnly: true, /** (boolean) httpOnly or not (default true) */\n    signed: true, /** (boolean) signed or not (default true) */\n    rolling: true, /** (boolean) Force a session identifier cookie to be set on every response. The expiration is reset to the original maxAge, resetting the expiration countdown. (default is false) */\n    renew: true, /** (boolean) renew session when session is nearly expired, so we can always keep user logged in. (default is false)*/\n    store: db_store,\n    valid(ctx: any, session: any) {\n        \n        if (session.__session_error) {\n            // 後續由 middleware 判斷是否有發生錯誤。\n            ctx.session_error = session.__session_error;\n            return false;\n        } else {\n            return true;\n        }\n    }\n};\n\nexport default (app: Koa) => {\n    return KoaSession(session_conf, app)\n}\n","import * as conf from 'config';\nimport { ServiceContext } from 'types';\n\nexport const getVideoRoot = (srcName?: string) => {\n    const name = srcName || 'default';\n    const found = conf.video_roots.find((v) => v.name === name);\n\n    if(found) {\n        return found.path;\n    } else {\n        return conf.video_roots.find((v) => v.name === 'default').path;\n    }\n}\n\nexport default conf;","import { exec } from \"child_process\";\nimport { FSUtil } from '../common/fs_util';\n\nexport interface CLIResult {\n    code: number;\n\n    output: string;\n}\n\nexport abstract class CLI {\n\n    constructor(\n        protected command: string\n    ) { }\n\n    public execute() {\n        const { command: cmd } = this;\n\n        const p = exec(cmd, {cwd: this.getCWD()});\n\n        return new Promise<CLIResult>((r, j) => {\n            let lines: string[] = [], error = null;\n            p.stdout.on('data', (chunk) => {\n                lines.push(chunk);\n            });\n\n            p.stderr.on('data', (chunk) => {\n                console.log(chunk);\n            });\n\n            p.once('error', (err) => {\n                j(err);\n            });\n\n            p.once('exit', (code, _) => {\n                if (code === 0) {\n                    r({\n                        code: code,\n                        output: lines.join('')\n                    });\n                } else {\n                    j({ code: code });\n                }\n            });\n        });\n    }\n\n    /** 取得工作目錄。 */\n    public abstract getCWD(): string;\n}\n\nexport class FFProbeCLI extends CLI {\n\n    public getCWD(): string {\n        \n        const parts = this.command.split(' ');\n\n        let part: string = null;\n        while(!!(part = parts.shift())) {\n            // 「/」開頭的就是路徑。\n            if (part.startsWith('/')) { break; }\n\n            // 也有可能有「\"/」開頭，最後要把前後「\"」去掉。\n            if(part.startsWith('\"/')) {\n                part = part.substr(1, part.length - 2);\n                break;\n            }\n        }\n\n        return FSUtil.pathSplite(part).path;\n    }\n}\n\nexport class FFMpegCLI extends CLI {\n\n    public getCWD(): string {\n        // 算出工作目錄。\n        // return '/Users/yaoming/opt';\n\n        const parts = this.command.split(' ');\n\n        let part: string = null;\n        while(!!(part = parts.shift())) {\n\n            // 「-i」開頭的下一個就是路徑。\n            if (part.trim() !== '-i') { continue; }\n\n            const pathPart = [];\n\n            let p: string = null;\n            while(parts.length >= 0) {\n                p = parts.shift()\n                pathPart.push(p);\n\n                if(p.endsWith(\"\\\"\")) {\n                    break;\n                }\n            }\n            part = pathPart.join(\" \");\n\n            if (part.startsWith(\"\\\"\") && part.endsWith(\"\\\"\")) {\n                part = part.substr(1, part.length - 2);\n            }\n\n            break;\n        }\n\n        return FSUtil.pathSplite(part).path;\n    }\n}","import { TimeUtil } from './time_util';\nimport { FFProbeCLI, FFMpegCLI } from './cli';\nimport { FSUtil } from '../common/fs_util';\nimport path from 'path';\n\n/** 可處理影片相關事務。 */\nexport class FFMpeg {\n\n    /**\n     *Creates an instance of FFMpeg.\n     * @param {string} absolutePath 影片絕對路徑。\n     * @memberof FFMpeg\n     */\n    constructor(\n        private absolutePath: string\n    ) { }\n\n    /**\n     * 取得影片相關資訊。\n     */\n    public async getMetadata() {\n        const cmd = `ffprobe \"${this.absolutePath}\" -show_entries stream=duration,width,height,codec_type:stream_tags=DURATION,DURATION-eng -of json -v quiet`;\n\n        const cli = new FFProbeCLI(cmd);\n\n        const result = await cli.execute();\n\n        if(result.code === 0) {\n            const vd = JSON.parse(result.output);\n            return TimeUtil.analysis(vd)\n        } else {\n            throw new Error('執行 ffprobe 失敗。');\n        }\n    }\n\n    public async takeScreenshot(...seconds: number[]) {\n\n        let fn = FSUtil.pathSplite(this.absolutePath).base;\n\n        let count = 0;\n        for(const second of seconds) {\n            const post = (count++).toString().padStart(3, '0');\n            const cmd = `ffmpeg -ss ${second} -i \"${this.absolutePath}\" -r 1 -vframes 1 -y \"${fn}_${post}.jpg\"`\n\n            const cli = new FFMpegCLI(cmd);\n    \n            const result = await cli.execute();\n    \n            if(result.code !== 0) {\n                throw new Error('執行 ffprobe 失敗。');\n            }\n        }\n\n        return true;\n    }\n}\n","\nexport * from './models';\nexport * from './ffmpeg';","import { VideoMetadata, Stream, VideoData } from './models';\nimport moment from 'moment';\n\nexport class TimeUtil {\n\n    public static analysis(vd: VideoData) {\n\n        let duration = -1;\n        let foundStream: Stream;\n        for(const stream of vd.streams) {\n            if(stream.codec_type !== 'video') {\n                continue;\n            }\n\n            foundStream = stream;\n\n            if(stream.duration ?? false) {\n                duration = TimeUtil.asSeconds(stream.duration);\n                break;\n            } else {\n                \n                if (!stream.tags) { break; } //沒有 tags 屬性。\n\n                for(const tagName of Object.getOwnPropertyNames(stream.tags)) {\n                    const tagValue = stream.tags[tagName];\n                    duration = TimeUtil.asSeconds(tagValue);\n                    break;\n                }\n            }\n        }\n\n        return {\n            duration: duration,\n            width: +foundStream.width,\n            height: +foundStream.height,\n            origin: vd\n        } as VideoMetadata;\n    }\n\n    private static asSeconds(val: any) {\n        if(typeof(val) === 'number') {\n            return val;\n        } else {\n            if((val as string).indexOf(\":\") >= 0) {\n                return moment.duration(val).asSeconds();\n            } else {\n                return moment.duration(+val, 'seconds').asSeconds();\n            }\n        }\n    }\n\n}","import http from 'http';\nimport Koa from 'koa';\nimport serve from 'koa-static';\nimport send from 'koa-send';\nimport partialSend from 'send';\nimport Router from 'koa-router';\nimport bodyParser from 'koa-bodyparser'\nimport createSession from './common/session_store';\nimport { setupDBConnection, checkSessionData, setXFrameOptionsDENY, setVideoRoot } from './common/middlewares';\nimport allservice from './service';\nimport { getVideoRoot } from './config';\nimport * as qs from 'query-string';\n\nconst PORT = process.env.PORT || 3000;\n\nasync function main(app: Koa) {\n    app.keys = ['1234'];\n\n    // 靜態檔案。\n    app.use(serve(\"./public\"));\n\n    app.use(bodyParser());\n    app.use(setupDBConnection);\n    app.use(createSession(app));\n    app.use(checkSessionData);\n    app.use(setVideoRoot);\n\n\n    // 所有 server side 程式都由 /service 路徑開始。\n    const general = new Router();\n    general.use('/service', allservice.routes());\n    app.use(general.routes());\n\n    // 設定 X-Frame-Options: DENY，安全性掃描需要。\n    app.use(setXFrameOptionsDENY);\n\n    // 處理 html5 mode。\n    app.use(async (ctx) => {\n        console.log(`resource not found: 「${ctx.path}」, fallback to 「/index.html」.`);\n        await send(ctx, \"./public/index.html\"); // html5 mode\n    });\n\n    const callback = wrapCallback(app.callback());\n    const server = http.createServer(callback).listen(PORT);\n\n    (app as any).server = server;\n\n    console.log('complete');\n}\n\nconst wrapCallback = function(cb: http.RequestListener) {\n    return (req: http.IncomingMessage, rsp: http.ServerResponse) => {\n        const query = qs.parseUrl(req.url);\n        const aUrl = `path:${query.url}`; // 防止尋取代時不要出錯。\n        const src: string = query.query.src as string;\n\n        if(aUrl.startsWith('path:/media')) {\n            const rpath = aUrl.replace('path:/media', '');\n            const root = getVideoRoot(src);\n            partialSend(req,  `${root}${rpath}`, {\n                acceptRanges: true\n            }).pipe(rsp);\n        } else {\n            cb(req, rsp);\n        }\n    }\n}\n\nmain(new Koa());\n\n\n","import Router from 'koa-router';\nimport { ServiceContext } from '../types';\nimport { db as connections } from '../common/database';\nconst db = connections.default;\n\nexport class ACL {\n\n    public static async source(ctx: ServiceContext) {\n        const { src } = ctx.query;\n\n        ctx.session.video_src = src;\n\n        ctx.redirect('/');\n    }\n\n}\n\nexport default new Router()\n    .get('/acl/source', ACL.source)\n    ;\n","import Router from 'koa-router';\nimport { ServiceContext } from '../types';\nimport { db as connections } from '../common/database';\nimport { VideoFS } from '../videofs/video_fs';\nimport { VideoFile } from '../videofs/video_file';\n\nconst db = connections.default;\nexport class FS {\n\n    public static async list(ctx: ServiceContext) {\n        const { videoRoot } = ctx;\n        const { q = '.' } = ctx.query;\n\n        const vr = new VideoFS(videoRoot);\n        const pathInfoList = await vr.list(q);\n\n        ctx.body = {\n            videos: pathInfoList\n            .map(v => {\n                return {\n                    name: v.name,\n                    path: v.getPath(),\n                    size: v.isDir ? 0 : v.size, \n                    isFile: v.isFile, \n                    format: new VideoFile(vr, v).format,\n                    isVideo: VideoFile.isVideo(v)\n                };\n            })\n        };\n    }\n}\n\nexport default new Router()\n    .get('/fs/list', FS.list)\n    ;\n","import Router from 'koa-router';\nimport fs from './fs';\nimport video from './video';\nimport acl from './acl';\n\nexport default new Router()\n    .use(fs.routes())\n    .use(video.routes())\n    .use(acl.routes())\n    ;\n","import Router from 'koa-router';\nimport { VideoFS } from '../videofs/video_fs';\nimport { VideoFile } from '../videofs/video_file';\nimport { FFMpeg } from '../ffmpeg';\nimport { ServiceContext } from '../types';\n\nexport class Video {\n    public static async metadata(ctx: ServiceContext) {\n        const { videoRoot } = ctx;\n        const { video } = ctx.query;\n\n        const vfs = new VideoFS(videoRoot);\n        const vod = await VideoFile.fromFile(vfs, video);\n\n        const ffmpeg = new FFMpeg(vod.absolutePath);\n\n        const metadata = await ffmpeg.getMetadata();\n        ctx.body = metadata;\n    }\n\n    public static async screenshot(ctx: ServiceContext) {\n        const { videoRoot } = ctx;\n        const { video, seconds } = ctx.query;\n\n        const v = video;\n        const vfs = new VideoFS(videoRoot);\n        const vod = await VideoFile.fromFile(vfs, v);\n\n        const ffmpeg = new FFMpeg(vod.absolutePath);\n\n        const success = await ffmpeg.takeScreenshot(seconds);\n        ctx.body = {\n            status: success\n        };\n    }\n}\n\n\nexport default new Router()\n.get('/video/metadata', Video.metadata)\n.get('/video/screenshot', Video.screenshot)\n;","import fsex from 'fs-extra';\nimport path from 'path';\nimport { VideoFS } from './video_fs';\nimport { FSUtil } from '../common/fs_util';\n/**\n *可代表媒體檔與非媒體檔案。\n */\nexport class FSEntry {\n\n    constructor(\n        filePath: string,\n        private state: fsex.Stats\n    ) {\n        const pathParts = FSUtil.pathSplite(filePath);\n\n        this.name = pathParts.file;\n        this.path = pathParts.path;\n    }\n\n    public path: string;\n\n    public name: string;\n\n    /**\n     * 取得檔案絕對路徑。\n     * @param withName 是否包含檔名。\n     */\n    public getAbsolutePath(fs: VideoFS, withName: boolean = true) {\n        if (withName) {\n            return path.join(fs.basePath, this.path, this.name);\n        } else {\n            return path.join(fs.basePath, this.path);\n        }\n    }\n\n    /**\n     * 取得檔案路徑。\n     * @param withName 是否包含檔案。\n     */\n    public getPath(withName: boolean = true) {\n        if (withName) {\n            return path.join(this.path, this.name);\n        } else {\n            return this.path;\n        }\n    }\n\n    public get size() { return this.state.size; }\n\n    public get isDir() { return this.state.isDirectory(); }\n\n    public get isFile() { return this.state.isFile(); }\n\n    /**\n     * 是否為總統檔案，包含一些 metadata 檔案。\n     *\n     * @readonly\n     * @memberof FSEntry\n     */\n    public get isSystemFile() {\n        const equals = [\n            '.DS_Store'\n        ]\n\n        const endWiths = [\n            '.zoemd',\n            '.zoemd.jpg' // 影片縮圖。\n        ]\n\n        if (this.name.startsWith('.')) {\n            return true;\n        }\n\n        if (endWiths.find(v => this.name.endsWith(v))) {\n            return true;\n        }\n\n        return equals.find(v => v === this.name);\n    }\n}","\nexport class Util {\n\n    public static supportVideoFormats = [\n        '.mp4',\n        '.mkv',\n        '.wmv',\n        '.rmvb',\n        '.avi'\n    ];\n\n    public static supportImageFormats = [\n        '.jpg',\n        '.png'\n    ]\n\n    public static isVideoFile(file: string) {\n        return Util.supportVideoFormats.find(f => {\n            return file.endsWith(f);\n        }) || 'none';\n    }\n\n    public static isImageFile(file: string) {\n        return Util.supportImageFormats.find(f => {\n            return file.endsWith(f);\n        }) || 'none';\n    }\n\n    public static isMediaFile(file: string) {\n        const video = Util.isVideoFile(file);\n\n        if(video === 'none') {\n            return Util.isImageFile(file);\n        } else {\n            return video;\n        }\n    }\n}","import { FSEntry } from './fs_entry';\nimport { Util } from './util';\nimport fsex from 'fs-extra';\nimport path from 'path';\nimport { VideoFS } from './video_fs';\n\n/**\n *代表一個影片檔案，不含其他檔案資訊。\n */\nexport class VideoFile {\n\n    constructor(\n        private vfs: VideoFS,\n        /** 代表影片檔案的檔案資訊。 */\n        public entry: FSEntry\n    ) { }\n\n    /**\n     *是否為影片檔案。\n     */\n    public static isVideo(entry: FSEntry) {\n        return (Util.isVideoFile(entry.name) !== 'none') && entry.isFile\n    }\n\n    /** 從影片檔路徑建立 VideoFile 物件。 */\n    public static async fromFile(vfs: VideoFS, filePath: string) {\n        const fullpath = path.join(vfs.basePath, filePath);\n        const fpstat = await fsex.stat(fullpath);\n\n        return new VideoFile(vfs, new FSEntry(filePath, fpstat));\n    }\n\n    /**\n     *影片格式。\n     */\n    public get format() { \n        if (!this.entry.isFile) { return false; }\n\n        return Util.isVideoFile(this.entry.name);\n    }\n\n    /** 取得影片絕對路徑。 */\n    public get absolutePath() {\n        return this.entry.getAbsolutePath(this.vfs);\n    }\n}","import fsex from 'fs-extra';\nimport path from 'path';\nimport { FSEntry } from './fs_entry';\n\n/**\n * 可處理媒體檔與非媒體檔增刪調整。\n */\nexport class VideoFS {\n\n    constructor(public basePath: string) { }\n\n    /**\n     *列出指定目錄檔案。\n     * @param {string} relPath 子目錄名稱。\n     * @param {boolean} [withoutSystemFile=true] 不包含系統檔與穩藏檔，預設為「true」。\n     */\n    public async list(relPath: string, withoutSystemFile: boolean = true) {\n        const entries = await fsex.readdir(path.join(this.basePath, relPath));\n\n        const fsentries: FSEntry[] = []\n        for (const e of entries) {\n            const file = path.join(relPath, e);\n\n            // 加上基礎路徑才是完整路徑。\n            const fpstat = await fsex.stat(path.join(this.basePath, file));\n            fsentries.push(new FSEntry(file, fpstat));\n        }\n\n        if(withoutSystemFile) {\n            return fsentries.filter(v => !v.isSystemFile);\n        } else {\n            return fsentries;\n        }\n    }\n}\n\n\n","module.exports = require(\"child_process\");","module.exports = require(\"./config.json\");","module.exports = require(\"fs-extra\");","module.exports = require(\"http\");","module.exports = require(\"koa\");","module.exports = require(\"koa-bodyparser\");","module.exports = require(\"koa-router\");","module.exports = require(\"koa-send\");","module.exports = require(\"koa-session\");","module.exports = require(\"koa-static\");","module.exports = require(\"moment\");","module.exports = require(\"path\");","module.exports = require(\"pg-promise\");","module.exports = require(\"query-string\");","module.exports = require(\"send\");","module.exports = require(\"tslib\");"],"sourceRoot":""}