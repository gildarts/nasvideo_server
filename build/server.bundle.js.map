{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/common/database.ts","webpack:///./src/common/fs_util.ts","webpack:///./src/common/middlewares.ts","webpack:///./src/common/session_store.ts","webpack:///./src/config.ts","webpack:///./src/ffmpeg/cli.ts","webpack:///./src/ffmpeg/ffmpeg.ts","webpack:///./src/ffmpeg/index.ts","webpack:///./src/ffmpeg/time_util.ts","webpack:///./src/media_server.ts","webpack:///./src/server.ts","webpack:///./src/service/acl.ts","webpack:///./src/service/fs.ts","webpack:///./src/service/index.ts","webpack:///./src/service/video.ts","webpack:///./src/service/zoemd.ts","webpack:///./src/videofs/fs_entry.ts","webpack:///./src/videofs/util.ts","webpack:///./src/videofs/video_file.ts","webpack:///./src/videofs/video_fs.ts","webpack:///./src/videofs/video_media.ts","webpack:///external \"child_process\"","webpack:///external \"./config.json\"","webpack:///external \"fs-extra\"","webpack:///external \"http\"","webpack:///external \"koa\"","webpack:///external \"koa-bodyparser\"","webpack:///external \"koa-router\"","webpack:///external \"koa-send\"","webpack:///external \"koa-session\"","webpack:///external \"koa-static\"","webpack:///external \"moment\"","webpack:///external \"mongodb\"","webpack:///external \"path\"","webpack:///external \"pg-promise\"","webpack:///external \"query-string\"","webpack:///external \"send\"","webpack:///external \"tslib\""],"names":[],"mappings":"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","file":"server.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/server.ts\");\n","/**\n * 資料庫相關初始設定。\n *\n * Library：https://github.com/vitaly-t/pg-promise\n * Example : https://github.com/vitaly-t/pg-promise/wiki/Learn-by-Example#single-parameter\n * TypeScript Ext Document：https://github.com/vitaly-t/pg-promise/tree/master/typescript\n */\n\nimport PGP from 'pg-promise';\nimport conf from '../config';\nimport PG from 'pg-promise';\n\nimport { MongoClient, Db } from 'mongodb';\n\n/** mongo db client。 */\nconst {user, password, host, port} = conf.bson;\nexport const bsonDB = new MongoClient(`mongodb://${user}:${password}@${host}:${port}`, {\n    useNewUrlParser: true,\n    useUnifiedTopology:true,\n    poolSize: 6,\n});\n\nconst pgp = PG();\n\n/**資料庫操作介面 */\nexport interface PGConnection extends PGP.IDatabase<any> {\n}\n\n/** 資料庫連線 instance。 */\nexport const db = {\n    /** 預設資料庫連線(字音字形網資料庫)。 */\n    default: pgp<PGConnection>(conf.db),\n    /** mongo db 資料庫。 */\n    mongo: null,\n} as {\n    default: PGConnection,\n    mongo: MongoClient,\n    mongodb: Db,\n}\n\n","import path from 'path';\n\nexport class FSUtil {\n\n    /** 將檔案路徑切割為「檔案」與「路徑」。 */\n    public static pathSplite(filePath: string) {\n        const paths = filePath.split('/').reverse();\n\n        const file = paths.shift()\n        const ext = path.extname(file);\n        const base = path.basename(file, ext);\n        return {\n            /** 檔案名稱。 */\n            file,\n            /** 副檔名。 */\n            ext,\n            /** 主檔名。 */\n            base,\n            /** 路徑 */\n            path: paths.reverse().join('/')\n        }\n    }\n}","import { ServiceContext } from '../types';\nimport { db } from './database';\nimport { getVideoRoot } from '../config';\nimport { VideoFS } from '../videofs/video_fs';\nimport { VideoFile } from '../videofs/video_file';\n\nexport const setXFrameOptionsDENY = (ctx: ServiceContext, next: () => Promise<void>) => {\n    ctx.response.set({\n        'X-Frame-Options': 'DENY',\n    })\n    return next();\n}\n\nexport const setupDBConnection = (ctx: ServiceContext, next: () => Promise<void>) => {\n    ctx.db = db.default;\n    return next();\n}\n\n\nexport const checkSessionData = (ctx: ServiceContext, next: () => Promise<void>) => {\n    if(ctx.session_error) {\n        const { message } = ctx.session_error;\n        ctx.status = 500;\n        ctx.body = { message };\n    } else {\n        return next();\n    }\n}\n\nexport const setVideoRoot = (ctx: ServiceContext, next: () => Promise<void>) => {   \n    ctx.videoRoot = getVideoRoot(ctx.session.video_src);\n    ctx.vfs = new VideoFS(ctx.videoRoot);\n    return next();\n};\n\nexport const prepareVideoInfo = async (ctx: ServiceContext, next: any) => {\n    const { vfs } = ctx;\n\n    let video = '';\n    if (ctx.request.query?.video) {\n        video = ctx.request.query.video;\n    }\n\n    if (ctx.request.body?.video) {\n        video = ctx.request.body.video;\n    }\n\n    if (!video) {\n        return next();\n    }\n    ctx.vod = await VideoFile.fromFile(vfs, video);\n\n    return next();\n}\n","import { db } from './database';\nimport KoaSession from 'koa-session';\nimport Koa from 'koa';\n\nconst TableName = 'session';\n\nconst db_store = {\n    get: async (key: string, maxAge: number, { rolling }: { rolling: any }) => {\n        try {\n            const mongodb = db.mongodb;\n\n            const session = mongodb.collection(TableName);\n            const bsonRecord = await session.findOne({session_id: key});\n\n            if (bsonRecord) {\n                const data = bsonRecord.data || {};\n                data._id = key;\n                return data;\n            } else {\n                return null;\n            }\n        } catch(err) {\n            return { __session_error: err };\n        }\n    },\n    set: async (key: string, sess: any, maxAge: number, { rolling, changed }: { rolling: any, changed: any }) => {\n\n        try {\n            if (!changed) return;\n\n            const mongodb = db.mongodb;\n            const session = mongodb.collection(TableName);\n\n            await session.findOneAndUpdate({ session_id: key }, {\n                $set: { data: sess, expiration: new Date() }\n            }, {\n                upsert: true\n            });\n        } catch (error) {\n            console.error(`set session occure error: ${error.message}`);\n        }\n    },\n    destroy: async (key: string) => {\n        const mongodb = db.mongodb;\n        const session = mongodb.collection(TableName);\n\n        await session.deleteOne({\n            session_id: key\n        });\n    }\n};\n\nconst session_conf = {\n    key: 'koa_nasvideo', /** (string) cookie key (default is koa:sess) */\n    maxAge: 24 * 60 * 60 * 1000, // 用戶端 cookie 過期時間，多久沒使用 cookie 會失效。\n    overwrite: true, /** (boolean) can overwrite or not (default true) */\n    httpOnly: true, /** (boolean) httpOnly or not (default true) */\n    signed: true, /** (boolean) signed or not (default true) */\n    rolling: true, /** (boolean) Force a session identifier cookie to be set on every response. The expiration is reset to the original maxAge, resetting the expiration countdown. (default is false) */\n    renew: true, /** (boolean) renew session when session is nearly expired, so we can always keep user logged in. (default is false)*/\n    store: db_store,\n    valid(ctx: any, session: any) {\n        \n        if (session.__session_error) {\n            // 後續由 middleware 判斷是否有發生錯誤。\n            ctx.session_error = session.__session_error;\n            return false;\n        } else {\n            return true;\n        }\n    }\n};\n\nexport default (app: Koa) => {\n    return KoaSession(session_conf, app)\n}\n","import * as conf from 'config';\nimport { ServiceContext } from 'types';\n\nexport const getVideoRoot = (srcName?: string) => {\n    const name = srcName || 'default';\n    const found = conf.video_roots.find((v) => v.name === name);\n\n    if(found) {\n        return found.path;\n    } else {\n        return conf.video_roots.find((v) => v.name === 'default').path;\n    }\n}\n\nexport default conf;","import { exec } from \"child_process\";\nimport { FSUtil } from '../common/fs_util';\n\nexport interface CLIResult {\n    code: number;\n\n    output: string;\n}\n\nexport abstract class CLI {\n\n    constructor(\n        protected command: string,\n        private cwd?: string\n    ) { }\n\n    public execute() {\n        const { command: cmd } = this;\n\n        const cwd = this.cwd;\n        const p = exec(cmd, {cwd});\n\n        return new Promise<CLIResult>((r, j) => {\n            let lines: string[] = [], error = null;\n            p.stdout.on('data', (chunk) => {\n                lines.push(chunk);\n            });\n\n            p.stderr.on('data', (chunk) => {\n                console.log(chunk);\n            });\n\n            p.once('error', (err) => {\n                j(err);\n            });\n\n            p.once('exit', (code, _) => {\n                if (code === 0) {\n                    r({\n                        code: code,\n                        output: lines.join('')\n                    });\n                } else {\n                    j({ code: code });\n                }\n            });\n        });\n    }\n}\n\nexport class FFProbeCLI extends CLI {\n}\n\nexport class FFMpegCLI extends CLI {\n}","import { TimeUtil } from './time_util';\nimport { FFProbeCLI, FFMpegCLI } from './cli';\nimport { FSUtil } from '../common/fs_util';\nimport path from 'path';\n\n/** 可處理影片相關事務。 */\nexport class FFMpeg {\n\n    /**\n     *Creates an instance of FFMpeg.\n     * @param {string} absolutePath 影片絕對路徑。\n     * @memberof FFMpeg\n     */\n    constructor(\n        private absolutePath: string,\n        private cwd = path.dirname(absolutePath)\n    ) { }\n\n    /**\n     * 取得影片相關資訊。\n     */\n    public async getMetadata() {\n        const cmd = `ffprobe \"${this.absolutePath}\" -show_entries stream=duration,width,height,codec_name,codec_type:stream_tags=DURATION,DURATION-eng -of json -v quiet`;\n\n        const cli = new FFProbeCLI(cmd, this.cwd);\n\n        const result = await cli.execute();\n\n        if(result.code === 0) {\n            const vd = JSON.parse(result.output);\n            return TimeUtil.analysis(vd)\n        } else {\n            throw new Error('執行 ffprobe 失敗。');\n        }\n    }\n\n    public async takeScreenshot(secondsList: { seconds: number, index?: number, name?: string }[]) {\n\n        let fn = FSUtil.pathSplite(this.absolutePath).base;\n\n        for(const each of secondsList) {\n            let fileName = each.name;\n\n            if (!each.name) { \n                const post = (each.index).toString().padStart(3, '0');\n                fileName = `${fn}_${post}`;    \n             }\n\n            const cmd = `ffmpeg -ss ${each.seconds} -i \"${this.absolutePath}\" -r 1 -vframes 1 -vf scale=640:-1 -y \"${fileName}.jpg\"`\n\n            const cli = new FFMpegCLI(cmd, this.cwd);\n    \n            const result = await cli.execute();\n    \n            if(result.code !== 0) {\n                throw new Error('執行 ffprobe 失敗。');\n            }\n        }\n\n        return true;\n    }\n}\n","\nexport * from './models';\nexport * from './ffmpeg';","import { VideoMetadata, Stream, VideoData } from './models';\nimport moment from 'moment';\n\nexport class TimeUtil {\n\n    public static analysis(vd: VideoData) {\n\n        let duration = -1;\n        let foundStream: Stream;\n        for(const stream of vd.streams) {\n            if(stream.codec_type !== 'video') {\n                continue;\n            }\n\n            foundStream = stream;\n\n            if(stream.duration ?? false) {\n                duration = TimeUtil.asSeconds(stream.duration);\n                break;\n            } else {\n                \n                if (!stream.tags) { break; } //沒有 tags 屬性。\n\n                for(const tagName of Object.getOwnPropertyNames(stream.tags)) {\n                    const tagValue = stream.tags[tagName];\n                    duration = TimeUtil.asSeconds(tagValue);\n                    break;\n                }\n            }\n        }\n\n        return {\n            duration: duration,\n            width: +foundStream.width,\n            height: +foundStream.height,\n            codec_name: foundStream.codec_name,\n            codec_type: foundStream.codec_type,\n            origin: vd\n        } as VideoMetadata;\n    }\n\n    private static asSeconds(val: any) {\n        if(typeof(val) === 'number') {\n            return val;\n        } else {\n            if((val as string).indexOf(\":\") >= 0) {\n                return moment.duration(val).asSeconds();\n            } else {\n                return moment.duration(+val, 'seconds').asSeconds();\n            }\n        }\n    }\n\n}","import http from 'http';\nimport fsex from 'fs-extra';\nimport path from 'path';\nimport partialSend from 'send';\nimport { getVideoRoot } from './config';\nimport * as qs from 'query-string';\nimport { db as connections } from './common/database';\n\nexport const wrapCallback = function(cb: http.RequestListener) {\n    return async (req: http.IncomingMessage, rsp: http.ServerResponse) => {\n\n        const mongo = connections.mongodb;\n        const session = mongo.collection('session');\n\n        const query = qs.parseUrl(req.url);\n        const aUrl = `path:${decodeURIComponent(query.url)}`; // 防止尋取代時不要出錯。\n        const src = query.query.src;\n        const sid = getSessionId(req.headers.cookie);\n        const srcRecord = (await session.findOne({ session_id: sid })) || { data: {} }\n\n        if(aUrl.startsWith('path:/media')) {\n            const rpath = aUrl.replace('path:/media', '');\n            // 有指定 src 為優先。\n            const root = getVideoRoot(src || srcRecord.data.video_src);\n            const fullpath = path.join(root, rpath);\n\n            if(!await fsex.pathExists(fullpath) && query.query.default === 'jpg') {\n                partialSend(req, path.join(root, 'default.jpg')).pipe(rsp);\n            } else {\n                partialSend(req,  fullpath, {\n                    acceptRanges: true\n                }).pipe(rsp);\n            }\n        } else {\n            cb(req, rsp);\n        }\n    }\n}\n\nconst getSessionId = function(cookie: string) {\n    if (!!!cookie) { return ''; }\n    if (cookie.indexOf('koa_nasvideo') < 0) { return ''; }\n\n    const pattern = /koa_nasvideo=([\\w\\d-]*);/;\n    return pattern.exec(cookie)[1];\n}","import http from 'http';\nimport Koa from 'koa';\nimport serve from 'koa-static';\nimport send from 'koa-send';\nimport Router from 'koa-router';\nimport bodyParser from 'koa-bodyparser'\nimport createSession from './common/session_store';\nimport { setupDBConnection, checkSessionData, setXFrameOptionsDENY, setVideoRoot } from './common/middlewares';\nimport allservice from './service';\nimport { db as connections, bsonDB } from './common/database';\nimport { wrapCallback } from './media_server';\nimport conf from 'config';\n\nconst db = connections.default;\nconst PORT = process.env.PORT || 3000;\n\nasync function main(app: Koa) {\n    app.keys = ['1234'];\n\n    connections.mongo = await bsonDB.connect();\n    connections.mongodb = connections.mongo.db(conf.bson.database);\n\n    // 靜態檔案。\n    app.use(serve(\"./public\"));\n\n    app.use(bodyParser());\n    app.use(setupDBConnection);\n    app.use(createSession(app));\n    app.use(checkSessionData);\n    app.use(setVideoRoot);\n\n    // 所有 server side 程式都由 /service 路徑開始。\n    const general = new Router();\n    general.use('/service', allservice.routes());\n    app.use(general.routes());\n\n    // 設定 X-Frame-Options: DENY，安全性掃描需要。\n    app.use(setXFrameOptionsDENY);\n\n    // 處理 html5 mode。\n    app.use(async (ctx) => {\n        console.log(`resource not found: 「${ctx.path}」, fallback to 「/index.html」.`);\n        await send(ctx, \"./public/index.html\"); // html5 mode\n    });\n\n    const callback = wrapCallback(app.callback());\n    const server = http.createServer(callback).listen(PORT);\n\n    (app as any).server = server;\n\n    console.log('complete');\n}\n\nmain(new Koa());\n\n\n","import Router from 'koa-router';\nimport { ServiceContext } from '../types';\nimport { db as connections } from '../common/database';\n\nexport class ACL {\n\n    public static async source(ctx: ServiceContext) {\n        const { src } = ctx.query;\n\n        ctx.session.video_src = src;\n\n        ctx.redirect('/play_list');\n        // ctx.body = `\n        // <html>\n        //     <body><a href=\"/\">${src || 'default'}</a></body>\n        // </html>\n        // `;\n    }\n\n    public static async mongodb(ctx: ServiceContext) {\n        const mongo = connections.mongodb;\n\n        const coll = mongo.collection('session');\n\n        // const ret = await coll.insert({\n        //     session_id: Date.now(), \n        //     create_at: new Date(),\n        //     data: {\n        //         names: [\n        //             'cindy',\n        //             'sandy'\n        //         ],\n\n        //     }\n        // });\n\n        const records = await coll.find().toArray();\n\n        ctx.session.count = (ctx.session.count || 0) + 1;\n\n        ctx.body = {\n            // news: ret.insertedIds,\n            records\n        }\n    }\n\n    public static async deleteall(ctx: ServiceContext) {\n        const mongo = await connections.mongo;\n\n        const coll = mongo.db('underground').collection('session');\n\n        const result = await coll.deleteMany({});\n\n        ctx.body = {\n            result\n        }\n    }\n\n}\n\nexport default new Router()\n    .get('/acl/source', ACL.source)\n    .get('/acl/mongodb', ACL.mongodb)\n    .get('/acl/deleteall', ACL.deleteall)\n    ;\n","import Router from 'koa-router';\nimport { ServiceContext } from '../types';\nimport { db as connections } from '../common/database';\nimport { VideoFS } from '../videofs/video_fs';\nimport { VideoFile } from '../videofs/video_file';\nimport path from 'path';\nimport { prepareVideoInfo } from '../common/middlewares';\n\nconst db = connections.default;\nexport class FS {\n\n    public static async list(ctx: ServiceContext) {\n        const { videoRoot } = ctx;\n        const { q = '.', all = false } = ctx.query;\n\n        const vr = new VideoFS(videoRoot);\n        const pathInfoList = await vr.list(q, all);\n\n        ctx.body = {\n            videos: pathInfoList\n                .map(v => {\n                    const video = new VideoFile(vr, v);\n                    return {\n                        name: v.name,\n                        path: v.getPath(),\n                        size: v.isDir ? 0 : v.size,\n                        isFile: v.isFile,\n                        format: video.format,\n                        isVideo: VideoFile.isVideo(v),\n                        containsZoemd: VideoFile.isVideo(v) ? video.containsZoemd() : false,\n                        create_time: v.createTime\n                    };\n                })\n        };\n    }\n\n    public static async move_to_parent(ctx: ServiceContext) {\n        const { vfs } = ctx;\n\n        const dirname = path.dirname(ctx.vod.absolutePath);\n        const basename = path.basename(ctx.vod.absolutePath);\n        await vfs.moveVideo(ctx.vod.absolutePath, `${dirname}/../${basename}`);\n\n        ctx.body = {\n            success: true,\n        }\n    }\n\n    public static async delete(ctx: ServiceContext) {\n        const { vfs } = ctx;\n        const { path } = ctx.params;\n\n        if (!path) throw new Error('沒有指定 path 參數。');\n\n        try {\n            await vfs.delete(path);\n\n            ctx.body = {\n                success: true,\n                path: path,\n            }\n        } catch (error) {\n            ctx.status = 404;\n            ctx.body = {\n                success: false,\n                message: error.message,\n            }\n        }\n\n        // const dirname = path.dirname(ctx.vod.absolutePath);\n        // const basename = path.basename(ctx.vod.absolutePath);\n        // await vfs.move(ctx.vod.absolutePath, `${dirname}/../${basename}`);\n\n    }\n}\n\nexport default new Router()\n    .use(prepareVideoInfo)\n    .delete('/fs/:path', FS.delete)\n    .get('/fs/list', FS.list)\n    .get('/fs/move_to_parent', FS.move_to_parent)\n    ;\n","import Router from 'koa-router';\nimport fs from './fs';\nimport video from './video';\nimport acl from './acl';\nimport zoemd from './zoemd';\n\nexport default new Router()\n    .use(fs.routes())\n    .use(video.routes())\n    .use(acl.routes())\n    .use(zoemd.routes())\n    ;\n","import Router from 'koa-router';\nimport { VideoFS } from '../videofs/video_fs';\nimport { VideoFile } from '../videofs/video_file';\nimport { VideoMedia } from '../videofs/video_media';\nimport { FFMpeg } from '../ffmpeg';\nimport { ServiceContext } from '../types';\n\nexport class Video {\n    public static async metadata(ctx: ServiceContext) {\n        const { videoRoot } = ctx;\n        const { video } = ctx.query;\n\n        const vfs = new VideoFS(videoRoot);\n        const vod = await VideoFile.fromFile(vfs, video);\n\n        const ffmpeg = new FFMpeg(vod.absolutePath);\n\n        const metadata = await ffmpeg.getMetadata();\n        ctx.body = metadata;\n    }\n\n    public static async screenshot(ctx: ServiceContext) {\n        const { videoRoot } = ctx;\n        const { video, seconds } = ctx.request.body;\n\n        const v = video;\n        const vfs = new VideoFS(videoRoot);\n        const vod = await VideoFile.fromFile(vfs, v);\n\n        const ffmpeg = new FFMpeg(vod.absolutePath);\n\n        const success = await ffmpeg.takeScreenshot(seconds);\n        ctx.body = {\n            status: success\n        };\n    }\n}\n\nexport default new Router()\n.get('/video/metadata', Video.metadata)\n.post('/video/screenshot', Video.screenshot)\n;","import Router from 'koa-router';\nimport { VideoFile } from '../videofs/video_file';\nimport { VideoMedia } from '../videofs/video_media';\nimport { ServiceContext } from '../types';\nimport { FFMpeg } from '../ffmpeg';\nimport fs from 'fs-extra';\nimport path from 'path';\n\nexport class Zoemd {\n\n    public static async zoemd_create(ctx: ServiceContext) {\n        const { vod } = ctx;\n        const { force = false } = ctx.request.body;\n\n        const ffmpeg = new FFMpeg(vod.absolutePath);\n        const metadata = await ffmpeg.getMetadata();\n        delete metadata.origin;\n        delete metadata.codec_type;\n\n        const result = await VideoMedia.createMedia(vod, metadata, force);\n        ctx.body = result || {\n            status: 'exists'\n        }\n    }\n\n    public static async zoemd_get(ctx: ServiceContext) {\n        const { vod } = ctx;\n        const media = new VideoMedia(vod);\n        ctx.body = await media.getZoemd();\n    }\n\n    public static async screenshot_set(ctx: ServiceContext) {\n        const { vod } = ctx;\n        const { seconds } = ctx.request.body;     \n\n        const media = new VideoMedia(vod);\n\n        const ffmpeg = new FFMpeg(vod.absolutePath, media.getZoemdPath().dir);\n\n        await ffmpeg.takeScreenshot([{\n            seconds: +seconds,\n            name: '' + Math.floor(+seconds)\n        }]);\n\n        await media.setScreenshot(+seconds);\n\n        ctx.body = await media.getZoemd()\n    }\n\n    public static async screenshot_remove(ctx: ServiceContext) {\n        const { vod } = ctx;\n        const { seconds } = ctx.request.query;\n\n        const media = new VideoMedia(vod);\n        const dir = media.getZoemdPath().dir;\n        \n        const abandonFile = path.join(dir, `${Math.floor(+seconds)}.jpg`);\n\n        if(await fs.pathExists(abandonFile)) {\n            await fs.remove(abandonFile);\n        }\n        await media.removeScreenshot(+seconds);\n\n        ctx.body = await media.getZoemd()\n    }\n    \n}\n\nexport default new Router()\n.use(async (ctx: ServiceContext, next: any) => {\n    const { vfs } = ctx;\n\n    let video = '';\n    if(ctx.request.query?.video) {\n        video = ctx.request.query.video;\n    }\n\n    if(ctx.request.body?.video) {\n        video = ctx.request.body.video;\n    }\n\n    if(!video) {\n        ctx.body = {\n            status: 'not found!'\n        }\n        ctx.state = 404;\n        return;\n    }\n    ctx.vod = await VideoFile.fromFile(vfs, video);\n\n    return next();\n})\n.post('/zoemd', Zoemd.zoemd_create)\n.get('/zoemd', Zoemd.zoemd_get)\n.post('/zoemd/screenshot', Zoemd.screenshot_set)\n.delete('/zoemd/screenshot', Zoemd.screenshot_remove)\n;","import fsex from 'fs-extra';\nimport path from 'path';\nimport { VideoFS } from './video_fs';\nimport { FSUtil } from '../common/fs_util';\n/**\n *可代表媒體檔與非媒體檔案。\n */\nexport class FSEntry {\n\n    constructor(\n        filePath: string,\n        private state: fsex.Stats\n    ) {\n        const pathParts = FSUtil.pathSplite(filePath);\n\n        this.name = pathParts.file;\n        this.path = pathParts.path;\n    }\n\n    public path: string;\n\n    public name: string;\n\n    /**\n     * 取得檔案絕對路徑。\n     * @param withName 是否包含檔名。\n     */\n    public getAbsolutePath(fs: VideoFS, withName: boolean = true) {\n        if (withName) {\n            return path.join(fs.basePath, this.path, this.name);\n        } else {\n            return path.join(fs.basePath, this.path);\n        }\n    }\n\n    /**\n     * 取得檔案路徑。\n     * @param withName 是否包含檔案。\n     */\n    public getPath(withName: boolean = true) {\n        if (withName) {\n            return path.join(this.path, this.name);\n        } else {\n            return this.path;\n        }\n    }\n\n    public get size() { return this.state.size; }\n\n    public get isDir() { return this.state.isDirectory(); }\n\n    public get isFile() { return this.state.isFile(); }\n\n    public get createTime() { return this.state.birthtimeMs; }\n\n    /**\n     * 是否為總統檔案，包含一些 metadata 檔案。\n     *\n     * @readonly\n     * @memberof FSEntry\n     */\n    public get isSystemFile() {\n        const equals = [\n            '.DS_Store'\n        ]\n\n        const startWiths = [\n            '.',\n            '@',\n            '#'\n        ]\n\n        const endWiths = [\n            '.zoemd',\n            '_recycle'\n        ]\n\n        if (startWiths.find(v => this.name.startsWith(v))) {\n            return true;\n        }\n\n        if (endWiths.find(v => this.name.endsWith(v))) {\n            return true;\n        }\n\n        return equals.find(v => v === this.name);\n    }\n}","import path from 'path';\n\nexport class Util {\n\n    public static supportVideoFormats = [\n        '.mp4',\n        '.mkv',\n        '.wmv',\n        '.rmvb',\n        '.avi'\n    ];\n\n    public static supportImageFormats = [\n        '.jpg',\n        '.png'\n    ]\n\n    public static isVideoFile(file: string) {\n        return Util.supportVideoFormats.find(f => {\n            return file.endsWith(f);\n        }) || 'none';\n    }\n\n    public static isImageFile(file: string) {\n        return Util.supportImageFormats.find(f => {\n            return file.endsWith(f);\n        }) || 'none';\n    }\n\n    public static isMediaFile(file: string) {\n        const video = Util.isVideoFile(file);\n\n        if(video === 'none') {\n            return Util.isImageFile(file);\n        } else {\n            return video;\n        }\n    }\n\n    public static getZoemdInfo(file: string) {\n        const zoemdDir = `${file}.zoemd`;\n        const zoemdFile = path.join(zoemdDir, 'video.json');\n\n        return {\n            dir: zoemdDir,\n            file: zoemdFile,\n        }\n    }\n}","import { FSEntry } from './fs_entry';\nimport { Util } from './util';\nimport fsex from 'fs-extra';\nimport path from 'path';\nimport { VideoFS } from './video_fs';\n\n/**\n *代表一個影片檔案，不含其他檔案資訊。\n */\nexport class VideoFile {\n\n    constructor(\n        private vfs: VideoFS,\n        /** 代表影片檔案的檔案資訊。 */\n        public entry: FSEntry\n    ) { }\n\n    /**\n     *是否為影片檔案。\n     */\n    public static isVideo(entry: FSEntry) {\n        return (Util.isVideoFile(entry.name) !== 'none') && entry.isFile\n    }\n\n    /** 從影片檔路徑建立 VideoFile 物件。 */\n    public static async fromFile(vfs: VideoFS, filePath: string) {\n        const fullpath = path.join(vfs.basePath, filePath);\n        const fpstat = await fsex.stat(fullpath);\n\n        return new VideoFile(vfs, new FSEntry(filePath, fpstat));\n    }\n\n    /**\n     *影片格式。\n     */\n    public get format() { \n        if (!this.entry.isFile) { return false; }\n\n        return Util.isVideoFile(this.entry.name);\n    }\n\n    /** 取得影片絕對路徑。 */\n    public get absolutePath() {\n        return this.entry.getAbsolutePath(this.vfs);\n    }\n\n    /** 是否包含了 Zoemd 資訊。 */\n    public containsZoemd() {\n        const exists = fsex.pathExistsSync(`${this.absolutePath}.zoemd`);\n        return exists;\n    }\n\n    public getZoemdPath() {\n        return `${this.absolutePath}.zoemd`;\n    }\n}","import fsex from 'fs-extra';\nimport path from 'path';\nimport { FSEntry } from './fs_entry';\n\n/**\n * 可處理媒體檔與非媒體檔增刪調整。\n */\nexport class VideoFS {\n\n    constructor(public basePath: string) { }\n\n    /**\n     *列出指定目錄檔案。\n     * @param {string} relPath 子目錄名稱。\n     * @param {boolean} [withSystemFile=true] 不包含系統檔與穩藏檔，預設為「true」。\n     */\n    public async list(relPath: string, withSystemFile: boolean = true) {\n        const entries = await fsex.readdir(path.join(this.basePath, relPath));\n\n        const fsentries: FSEntry[] = []\n        for (const e of entries) {\n            const file = path.join(relPath, e);\n\n            // 加上基礎路徑才是完整路徑。\n            const fpstat = await fsex.stat(path.join(this.basePath, file));\n            fsentries.push(new FSEntry(file, fpstat));\n        }\n\n        if(!withSystemFile) {\n            return fsentries.filter(v => !v.isSystemFile);\n        } else {\n            return fsentries;\n        }\n    }\n\n    /**\n     * 移動影片檔案(包含 zoemd 檔)。\n     * @param srcVideoPath 來源影片檔路徑。\n     * @param destVideoPath 目的目錄。\n     */\n    public async moveVideo(srcVideoPath: string, destVideoPath: string) {\n        const srcVideoZoemd = `${srcVideoPath}.zoemd`;\n        await fsex.move(srcVideoPath, destVideoPath);\n\n        if(await fsex.pathExists(srcVideoZoemd)) {\n            await fsex.move(srcVideoZoemd, `${destVideoPath}.zoemd`)\n        }\n    }\n\n    public async delete(relPath: string) {\n        const p = path.join(this.basePath, relPath);\n        const recycle = path.join(this.basePath, '/_recycle');\n        if(await fsex.pathExists(p)) {\n            await fsex.ensureDir(recycle);\n            const target = path.join(recycle, `${Date.now()}_${path.basename(p)}`);\n            await fsex.move(p, target);\n        } else {\n            throw new Error(`路徑不存在：${p}`);\n        }\n    }\n}\n\n\n","import { VideoFile } from './video_file';\nimport { Util } from './util';\nimport { Zoemd } from './zoemd';\nimport fsex from 'fs-extra';\n\n/**\n *代表一個影片媒體，包含了影片檔、縮圖檔、預覽檔等相關檔案與目錄。\n */\nexport class VideoMedia {\n\n    constructor(\n        /** 影片檔案資訊。 */\n        private file: VideoFile\n    ) { }\n\n    public static async createMedia(vf: VideoFile, metadata: any, force = false) {\n        const zoemd = Util.getZoemdInfo(vf.absolutePath);\n\n        await fsex.ensureDir(zoemd.dir);\n        if (await fsex.pathExists(zoemd.file) && !force) {\n            return false;\n        }\n\n        await fsex.writeJSON(zoemd.file, {\n            metadata,\n            screenshots: []\n        }, { spaces: 2 });\n\n        return {\n            zoemd,\n            metadata\n        }\n    }\n\n    public async getZoemd() {\n        const zoemd = Util.getZoemdInfo(this.file.absolutePath);\n        return await fsex.readJSON(zoemd.file);\n    }\n\n    public getZoemdPath() {\n        return Util.getZoemdInfo(this.file.absolutePath);\n    }\n\n    /** 加入快照時間點。 */\n    public async setScreenshot(seconds: number) {\n        const sec = +seconds;\n        const zoemdInfo = Util.getZoemdInfo(this.file.absolutePath);\n        const zoemd: Zoemd = await fsex.readJSON(zoemdInfo.file);\n\n        const screenshots = (zoemd.screenshots || [])\n            // 把 null、undefined 去掉。\n            // 秒數一樣的去掉。\n            .filter(v => ((v === 0 || !!v)) ?? false)\n            .filter(v => Math.floor(v) !== Math.floor(sec))\n\n        screenshots.push(sec);\n        screenshots.sort((x, y) => x - y);\n        zoemd.screenshots = screenshots;\n\n        await fsex.writeJSON(zoemdInfo.file, zoemd);\n    }\n\n    public async removeScreenshot(seconds: number) {\n        const sec = +seconds;\n        const zoemdInfo = Util.getZoemdInfo(this.file.absolutePath);\n        const zoemd: Zoemd = await fsex.readJSON(zoemdInfo.file);\n\n        const screenshots = (zoemd.screenshots || [])\n            // 把 null、undefined 去掉。\n            // 秒數一樣的去掉。\n            .filter(v => ((v === 0 || !!v)) ?? false)\n            .filter(v => Math.floor(v) !== Math.floor(sec))\n\n        zoemd.screenshots = screenshots;\n\n        await fsex.writeJSON(zoemdInfo.file, zoemd);\n    }\n}\n","module.exports = require(\"child_process\");","module.exports = require(\"./config.json\");","module.exports = require(\"fs-extra\");","module.exports = require(\"http\");","module.exports = require(\"koa\");","module.exports = require(\"koa-bodyparser\");","module.exports = require(\"koa-router\");","module.exports = require(\"koa-send\");","module.exports = require(\"koa-session\");","module.exports = require(\"koa-static\");","module.exports = require(\"moment\");","module.exports = require(\"mongodb\");","module.exports = require(\"path\");","module.exports = require(\"pg-promise\");","module.exports = require(\"query-string\");","module.exports = require(\"send\");","module.exports = require(\"tslib\");"],"sourceRoot":""}